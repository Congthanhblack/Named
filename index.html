<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPH-SOC // SMART TRAFFIC MONITORING</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #000; color: #00ff41; font-family: 'JetBrains Mono', monospace; overflow: hidden; height: 100vh; }
        .cyber-border { border: 1px solid #004411; background: rgba(0, 5, 0, 0.9); }
        .glitch-bg { background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 255, 0, 0.06)); background-size: 100% 2px, 3px 100%; }
        .terminal-input { background: transparent; border: none; outline: none; color: #fff; width: 100%; font-size: 12px; }
        .cam-slot { position: relative; background: #050505; border: 1px solid #111; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #004411; }
        .violation-row { border-bottom: 1px solid #002200; padding: 6px 0; font-size: 10px; transition: all 0.3s; }
        .violation-row:hover { background: rgba(255, 0, 0, 0.1); cursor: pointer; }
        .server-error-overlay { position: absolute; inset: 0; background: rgba(255, 0, 0, 0.1); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 10; }
    </style>
</head>
<body class="p-1 flex flex-col space-y-1">

    <header class="h-12 cyber-border flex items-center justify-between px-4">
        <div class="flex items-center space-x-3">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/af/Vietnam_Coat_of_Arms.svg" class="h-7">
            <div>
                <h1 class="text-xs font-bold text-white uppercase tracking-tighter">IOC HAIPHONG CITY - QUẢN TRỊ HỆ THỐNG</h1>
                <p class="text-[8px] text-green-700">Trạng thái: <span id="system-status" class="text-red-500 blink font-bold">LỖI PHÂN ĐOẠN SERVER CỤM (NODE_02)</span></p>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <span id="session-timer" class="text-white font-bold text-lg">30:00</span>
            <button onclick="location.reload()" class="bg-red-900/40 border border-red-600 px-3 py-1 text-[10px] text-white font-bold uppercase">Thiết lập lại</button>
        </div>
    </header>

    <div class="flex-1 flex space-x-1 overflow-hidden">
        
        <div class="w-[32%] flex flex-col space-y-1">
            <div class="flex-1 cyber-border p-2 flex flex-col overflow-hidden">
                <h3 class="text-[10px] font-bold text-green-600 border-b border-green-950 pb-1 mb-2 uppercase italic">Nhật ký AI & Hạ tầng Server</h3>
                <div id="log-box" class="flex-1 overflow-y-auto text-[10px] space-y-1 font-mono">
                </div>
            </div>

            <div class="h-[45%] cyber-border p-2 flex flex-col overflow-hidden">
                <h3 class="text-[10px] font-bold text-yellow-600 border-b border-yellow-950 pb-1 mb-2 uppercase">Vi phạm ghi nhận (Unique Plates)</h3>
                <div id="violation-box" class="flex-1 overflow-y-auto font-mono">
                </div>
            </div>
        </div>

        <div id="camera-grid" class="flex-1 cyber-border grid grid-cols-3 grid-rows-3 gap-1 p-1 bg-black overflow-hidden">
            </div>
    </div>

    <div class="h-28 cyber-border bg-black flex flex-col">
        <div class="bg-zinc-900 px-2 py-0.5 text-[9px] flex justify-between text-gray-500 border-b border-green-900">
            <span>HPH_CORE_COMMANDER v4.2 // SHARED_SERVER_OS</span>
            <span id="live-ping">PING: 14ms</span>
        </div>
        <div id="terminal-screen" class="flex-1 p-2 text-[11px] overflow-y-auto font-mono text-gray-400">
            <div>[INFO] Hệ thống khởi động thành công. Kết nối Server Node_01: OK, Node_02: TIMEOUT...</div>
        </div>
        <div class="p-2 border-t border-green-900 flex items-center">
            <span class="text-green-500 mr-2 font-bold">admin@ioc_hph:></span>
            <input type="text" id="cli-input" class="terminal-input" autocomplete="off" placeholder="Nhập lệnh điều khiển...">
        </div>
    </div>

    <div id="access-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="w-[350px] border-2 border-red-600 p-6 text-center bg-black shadow-[0_0_20px_rgba(255,0,0,0.3)]">
            <i class="fas fa-exclamation-triangle text-4xl text-red-600 mb-4"></i>
            <h2 class="text-red-600 font-bold mb-2 uppercase">Quyền truy cập bị từ chối</h2>
            <p class="text-[10px] text-gray-400 mb-6 italic">Yêu cầu xác thực tài khoản QUẢN TRỊ VIÊN CẤP 6 để truy xuất dữ liệu định danh chủ phương tiện.</p>
            <button onclick="document.getElementById('access-modal').classList.add('hidden')" class="px-6 py-2 bg-red-700 text-white font-bold text-xs">ĐÓNG</button>
        </div>
    </div>

    <script>
        const logBox = document.getElementById('log-box');
        const vioBox = document.getElementById('violation-box');
        const termScreen = document.getElementById('terminal-screen');
        const cliInput = document.getElementById('cli-input');
        const cameraGrid = document.getElementById('camera-grid');

        // Danh sách khu vực mở rộng và phân cụm Server
        const cameras = [
            { id: "01", name: "CẦU BÍNH", node: "NODE_01" },
            { id: "02", name: "LẠCH TRAY", node: "NODE_01" },
            { id: "03", name: "ĐỒ SƠN - KHU 2", node: "NODE_02" },
            { id: "04", name: "TÔ HIỆU", node: "NODE_01" },
            { id: "05", name: "CẦU RÀO 2", node: "NODE_01" },
            { id: "06", name: "THỦY NGUYÊN", node: "NODE_02" },
            { id: "07", name: "CÁT BÀ - CẢNG", node: "NODE_02" },
            { id: "08", name: "LÊ CHÂN", node: "NODE_01" },
            { id: "09", name: "TIÊN LÃNG", node: "NODE_02" }
        ];

        // Biển số và lỗi
        const platesPool = ["15A-452.12", "16L-998.34", "15B-211.09", "15C-445.67", "15A-002.88", "16H-778.21", "15K-331.45", "15A-888.88", "15B-667.22", "16M-112.33"];
        const faultTypes = ["KHÔNG XI NHAN", "SAI LÀN ĐƯỜNG", "VƯỢT ĐÈN ĐỎ", "ĐI NGƯỢC CHIỀU", "DỪNG ĐỖ TRÁI PHÉP"];

        // Quản lý vi phạm: plate -> Set of faults
        let violationsMap = new Map();

        function initCameras() {
            cameraGrid.innerHTML = '';
            cameras.forEach(cam => {
                const div = document.createElement('div');
                div.id = `cam-${cam.id}`;
                div.className = `cam-slot glitch-bg group`;
                div.innerHTML = `
                    <div id="error-${cam.id}" class="server-error-overlay hidden">
                        <i class="fas fa-server text-red-600 text-xl mb-1 opacity-50"></i>
                        <span class="text-[7px] text-red-500">SERVER ${cam.node} ERROR</span>
                    </div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center opacity-20">
                        <i class="fas fa-video-slash text-2xl mb-1"></i>
                        <span class="text-[7px]">SIGNAL LOST</span>
                    </div>
                    <div class="absolute top-1 left-1 bg-black/80 px-1 text-[8px] text-green-500 border-l border-green-600">
                        ${cam.name} (${cam.node})
                    </div>
                    <div class="absolute bottom-1 right-2 text-[8px] text-green-900">FPS: 0.0</div>
                `;
                cameraGrid.appendChild(div);
            });
        }

        function addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString();
            let color = 'text-green-500';
            if (type === 'error') color = 'text-red-500';
            if (type === 'user') color = 'text-blue-400';
            if (type === 'warn') color = 'text-yellow-500';

            const div = document.createElement('div');
            div.className = color;
            div.innerHTML = `<span class="text-gray-600">[${time}]</span> > ${msg}`;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        function spawnViolation() {
            const plate = platesPool[Math.floor(Math.random() * platesPool.length)];
            const fault = faultTypes[Math.floor(Math.random() * faultTypes.length)];

            if (!violationsMap.has(plate)) {
                // Tạo mới biển số vi phạm
                violationsMap.set(plate, new Set([fault]));
                renderViolationRow(plate, fault);
                addLog(`AI_DETECT: Phát hiện ${plate} - ${fault.toLowerCase()}`, 'warn');
            } else {
                // Biển số đã tồn tại, kiểm tra xem có thêm được lỗi thứ 2 không
                const existingFaults = violationsMap.get(plate);
                if (existingFaults.size < 2 && !existingFaults.has(fault)) {
                    existingFaults.add(fault);
                    updateViolationRow(plate, Array.from(existingFaults).join(' + '));
                    addLog(`AI_CRITICAL: ${plate} tái diễn vi phạm: ${fault.toLowerCase()}`, 'error');
                }
            }
        }

        function renderViolationRow(plate, fault) {
            const row = document.createElement('div');
            row.id = `vio-${plate.replace('.', '')}`;
            row.className = "violation-row flex justify-between";
            row.onclick = () => document.getElementById('access-modal').classList.remove('hidden');
            row.innerHTML = `<span class="text-white font-bold">${plate}</span> <span class="text-red-500 uppercase">${fault}</span>`;
            vioBox.prepend(row);
        }

        function updateViolationRow(plate, combinedFaults) {
            const row = document.getElementById(`vio-${plate.replace('.', '')}`);
            if (row) {
                row.innerHTML = `<span class="text-white font-bold">${plate}</span> <span class="text-yellow-500 uppercase">${combinedFaults}</span>`;
                row.classList.add('bg-red-900/20');
            }
        }

        // Mô phỏng lỗi server cục bộ
        function toggleNodeError(nodeId, isError) {
            cameras.forEach(cam => {
                if (cam.node === nodeId) {
                    const errorOverlay = document.getElementById(`error-${cam.id}`);
                    isError ? errorOverlay.classList.remove('hidden') : errorOverlay.classList.add('hidden');
                }
            });
            if(isError) {
                addLog(`CRITICAL: Server chung ${nodeId} mất kết nối cục bộ!`, 'error');
            } else {
                addLog(`SYSTEM: ${nodeId} đã được khôi phục.`, 'info');
            }
        }

        function init() {
            initCameras();
            addLog("ĐANG ĐỒNG BỘ DỮ LIỆU LIÊN NODE...", 'info');
            
            // Cứ 12-20 giây mới có vi phạm để thực tế
            setInterval(() => {
                if (Math.random() > 0.6) spawnViolation();
            }, 12000);

            // Mô phỏng lỗi NODE_02 (Đồ Sơn, Thủy Nguyên, Tiên Lãng...)
            setTimeout(() => toggleNodeError('NODE_02', true), 5000);

            // Timer
            let time = 1800;
            setInterval(() => {
                time--;
                const m = Math.floor(time/60).toString().padStart(2,'0');
                const s = (time%60).toString().padStart(2,'0');
                document.getElementById('session-timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        cliInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                const cmd = cliInput.value;
                const div = document.createElement('div');
                div.innerHTML = `<span class="text-green-500">admin@ioc_hph:></span> ${cmd}`;
                termScreen.appendChild(div);
                addLog(`Lệnh điều hành: '${cmd}'`, 'user');
                cliInput.value = '';
                termScreen.scrollTop = termScreen.scrollHeight;
            }
        });

        init();
    </script>
</body>
</html>
